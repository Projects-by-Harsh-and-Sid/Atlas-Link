<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phantom Testnet Transaction Example</title>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/buffer@6.0.3/index.js"></script>
</head>
<body>
    <h1>Phantom Testnet Transaction Example</h1>
    <button onclick="initiateTransaction()">Initiate Testnet Transaction</button>

    <script type="module">
        // Import Buffer from the buffer library
        import { Buffer } from 'https://cdn.jsdelivr.net/npm/buffer@6.0.3/+esm';

        // Make Buffer available globally
        window.Buffer = Buffer;

        // Testnet URL
        const TESTNET_URL = 'https://api.testnet.solana.com';

        async function fetchTransactionDetails() {
            try {
                const response = await fetch('/transaction_details.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error("Error fetching transaction details:", error);
                alert("Error fetching transaction details. Please check the console for more information.");
                throw error;
            }
        }

        async function connectToPhantom() {
            if (typeof window.solana === 'undefined') {
                throw new Error("Phantom wallet is not installed!");
            }

            try {
                const resp = await window.solana.connect();
                console.log("Connected to Phantom. Public key:", resp.publicKey.toString());
                return resp.publicKey;
            } catch (err) {
                console.error("Error connecting to Phantom:", err);
                throw new Error("Failed to connect to Phantom wallet.");
            }
        }

        async function initiateTransaction() {
            try {
                // Fetch transaction details from JSON
                const transactionDetails = await fetchTransactionDetails();

                // Connect to Phantom
                const publicKey = await connectToPhantom();

                // Create a connection to the Solana testnet
                const connection = new solanaWeb3.Connection(TESTNET_URL, 'confirmed');

                // Check if connected to testnet
                const genesisHash = await connection.getGenesisHash();
                if (genesisHash !== '4uhcVJyU9pJkvQyS88uRDiswHXSCkY3zQawwpjk2NsNY') {
                    throw new Error("Please switch to Solana Testnet in your Phantom wallet before proceeding.");
                }

                // Create a new transaction
                const transaction = new solanaWeb3.Transaction();

                // Create transfer instruction
                const instruction = solanaWeb3.SystemProgram.transfer({
                    fromPubkey: publicKey,
                    toPubkey: new solanaWeb3.PublicKey(transactionDetails.to),
                    lamports: solanaWeb3.LAMPORTS_PER_SOL * transactionDetails.amount
                });

                // Add instruction to transaction
                transaction.add(instruction);

                // Get recent blockhash
                const { blockhash } = await connection.getLatestBlockhash();
                transaction.recentBlockhash = blockhash;

                // Set the paying account
                transaction.feePayer = publicKey;

                // Sign and send the transaction
                const { signature } = await window.solana.signAndSendTransaction(transaction);

                console.log("Transaction sent:", signature);
                alert("Testnet transaction sent successfully! Signature: " + signature);

                // Wait for confirmation
                const confirmation = await connection.confirmTransaction(signature);
                console.log("Transaction confirmed:", confirmation);
                alert("Testnet transaction confirmed successfully!");
            } catch (error) {
                console.error("Error:", error);
                alert("Error sending transaction: " + error.message);
            }
        }

        // Make initiateTransaction available globally
        window.initiateTransaction = initiateTransaction;
    </script>
</body>
</html>